<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>HHS Flu Vaccination Data | Cactus</title>
	<link rel="shortcut icon" href="/static/images/favicon.ico">	
	<link rel="stylesheet" href="/static/css/style.css">
	<link rel="stylesheet" href="/static/css/notebook.css">
	<link rel="alternate" type="application/rss+xml" title="My Blog Feed" href="/rss.xml">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<style type="text/css">
    </style>
<style type="text/css">
</style>

</head>
<body>
	

<section id="wrapper" class="group">
	<header id="header">
		<a id="title" href="/">Big Data Science Bootcamp</a>
	</header>

	<article class="post">
		<section id="post-body">
			
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Loading-HHS-Flu-Vaccination-JSON-Data">Loading HHS Flu Vaccination JSON Data<a class="anchor-link" href="#Loading-HHS-Flu-Vaccination-JSON-Data">&#182;</a></h1>
</div>
</div>
</div>

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Sometimes data is already in a handy document store for us. JSON (JavaScript Object Notation) data is in the form of a list of objects composed of a set of key-value pairs.</p>
<p>In this exercise, we'll use basic python and the cx-Oracle to pull Flu Vaccination Data from HHS.gov and store it in a table in our database. The data and API are provided by the <a href="http://flu-vaccination-map.hhs.gov/">US HHS</a>. Since the data we want is already in JSON format, we won't need to do much parsing, we'll mostly just &quot;dump&quot; it into the database. As usual, we begin by importing the libraries we'll need.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">cx_Oracle</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First thing we'll need to do is write a quick helper function to &quot;jsonify&quot; our data. This will turn our data into separate JSON strings and return them as a list of tuples.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">jsonify_data</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
  <span class="k">return</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">),)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First, we'll need to connect to the database and make a table to store the data in. Because the data we're collecting is JSON, we can save time by assigning the whole document to a single column. For this exercise we'll just need one table, call it flu_shot_json with, one column, call it doc. We'll pull the 'results' from our data, jsonify it, then insert it into our table in the doc column.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="n">db</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;fludb&#39;</span><span class="p">,</span> <span class="s">&#39;flushot&#39;</span><span class="p">,</span> <span class="s">&#39;localhost:1521/orcl&#39;</span><span class="p">)</span>
<span class="n">drop_table</span> <span class="o">=</span> <span class="s">&#39;drop table flu_shot_json&#39;</span>
<span class="n">ddl</span> <span class="o">=</span> <span class="s">&#39;create table flu_shot_json (doc varchar2(4000), CONSTRAINT &quot;ENSURE_JSON&quot; CHECK (doc IS JSON))&#39;</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">drop_table</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
  <span class="k">pass</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ddl</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That's pretty much all the setup we need to do, so now we'll go ahead and create a <code>write to db</code> function.</p>
<p>As with most database operations, we need a cursor. Don't forget to commit the inserts after they've executed!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="k">def</span> <span class="nf">write_to_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
  <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
      <span class="n">cursor</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;INSERT INTO flu_shot_json(doc) VALUES (:1)&quot;</span><span class="p">)</span>
      <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">jsonify_data</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]))</span>
      <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">print</span> <span class="n">e</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now all we need to do is pull the data from HHS.gov and write it to the db. There are a number of ethnicities, so we need to collect all of them.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In&nbsp;[]:
</div>
<div class="inner_cell">
    <div class="input_area">
<div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;parsing dataset...&quot;</span>
<span class="k">for</span> <span class="n">eth</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;T&quot;</span><span class="p">,</span><span class="s">&quot;A&quot;</span><span class="p">,</span><span class="s">&quot;W&quot;</span><span class="p">,</span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="s">&quot;H&quot;</span><span class="p">]:</span>
  <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://flu-vaccination-map.hhs.gov/api/v1/states.json?ethnicity=&quot;</span><span class="o">+</span><span class="n">eth</span><span class="o">+</span><span class="s">&quot;&amp;year=lte:2014&quot;</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
  <span class="k">print</span> <span class="s">&quot;writing to DB...&quot;</span>
  <span class="n">write_to_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
    </div>
  </div>

		</section>
		
		<footer id="post-meta" class="clearfix">
			<div><span>Posted on </span> Oct 11</div>
			<div><span>Written by</span> Dan McClary</div>

			<section id="sharing">
				<a class="twitter" href="https://twitter.com/share"><span class="icon-twitter-circled"></span></a>

				<a class="facebook" href="#" 
				  onclick="
				    window.open(
				      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href), 
				      'facebook-share-dialog', 
				      'width=626,height=436'); 
				    return false;"><span class="icon-facebook-circled"></span> 
				</a>

			</section> 
		</footer> 
	</article>

	<footer>
	<nav id="post-nav">
		<span class="prev">
			
				<a href='/posts/Part_1/WHO_CountryLevel_Flu_Data.html'>
					<span class="arrow">&larr;</span> WHO Country-Level Flu Data
				</a>
			
		</span>
		

		<span class="next">
			
		</span>
	</nav>
	</footer>
</section> 



	
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="/static/js/main.js"></script>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-59027713-1', 'auto');
		  ga('send', 'pageview');
		</script>
	
</body>
</html>
